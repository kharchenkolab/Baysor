<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Cell segmentation · Baysor Documentation</title><meta name="title" content="Cell segmentation · Baysor Documentation"/><meta property="og:title" content="Cell segmentation · Baysor Documentation"/><meta property="twitter:title" content="Cell segmentation · Baysor Documentation"/><meta name="description" content="Documentation for Baysor Documentation."/><meta property="og:description" content="Documentation for Baysor Documentation."/><meta property="twitter:description" content="Documentation for Baysor Documentation."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Baysor Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><span class="tocitem">Running Baysor</span><ul><li><a class="tocitem" href="../run/">Summary</a></li><li class="is-active"><a class="tocitem" href>Cell segmentation</a><ul class="internal"><li><a class="tocitem" href="#Normal-run"><span>Normal run</span></a></li><li><a class="tocitem" href="#Using-a-prior-segmentation"><span>Using a prior segmentation</span></a></li><li><a class="tocitem" href="#Segmenting-cells-with-pronounced-intracellular-structure"><span>Segmenting cells with pronounced intracellular structure</span></a></li><li><a class="tocitem" href="#Outputs"><span>Outputs</span></a></li><li><a class="tocitem" href="#Choice-of-parameters"><span>Choice of parameters</span></a></li></ul></li><li><a class="tocitem" href="../preview/">Preview</a></li><li><a class="tocitem" href="../segfree/">Segmentation-free analysis</a></li><li><a class="tocitem" href="../configuration/">Advanced configuration</a></li></ul></li><li><a class="tocitem" href="../citation/">Citation info</a></li><li><a class="tocitem" href="../examples/">Examples</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Running Baysor</a></li><li class="is-active"><a href>Cell segmentation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Cell segmentation</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/kharchenkolab/Baysor" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/kharchenkolab/Baysor/blob/master/docs/src/segmentation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Segmentation"><a class="docs-heading-anchor" href="#Segmentation">Segmentation</a><a id="Segmentation-1"></a><a class="docs-heading-anchor-permalink" href="#Segmentation" title="Permalink"></a></h1><h2 id="Normal-run"><a class="docs-heading-anchor" href="#Normal-run">Normal run</a><a id="Normal-run-1"></a><a class="docs-heading-anchor-permalink" href="#Normal-run" title="Permalink"></a></h2><p>To run the algorithm on your data, use the following command:</p><pre><code class="language-bash hljs">baysor run &lt;args&gt; [options] [flags]</code></pre><p>CLI parameters:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Baysor.CommandLine.run" href="#Baysor.CommandLine.run"><code>Baysor.CommandLine.run</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><p>Run cell segmentation</p><p><strong>Args</strong></p><ul><li><code>coordinates</code>:            CSV or Parquet file with coordinates of molecules and gene type</li><li><code>prior_segmentation</code>:     Image or a MAT file with segmentation mask (either boolean or component indexing) or <code>coordinates</code>                           column with segmentation labels.                           If it&#39;s a column name, it should be preceded by &#39;:&#39; symbol (e.g. <code>:cell</code>)</li></ul><p><strong>Options</strong></p><ul><li><p><code>-c, --config=&lt;config.toml&gt;</code>:         TOML file with a config</p></li><li><p><code>-x, --x-column=&lt;x&gt;</code>:                 Name of x column. Overrides the config value.</p></li><li><p><code>-y, --y-column=&lt;y&gt;</code>:                 Name of y column. Overrides the config value.</p></li><li><p><code>-z, --z-column=&lt;z&gt;</code>:                 Name of z column. Overrides the config value.</p></li><li><p><code>-g, --gene-column=&lt;gene&gt;</code>:           Name of gene column. Overrides the config value.</p></li><li><p><code>-m, --min-molecules-per-cell=&lt;m&gt;</code>:   Minimal number of molecules for a cell to be considered as real.                                       It&#39;s an important parameter, as it&#39;s used to infer several other parameters.                                       Overrides the config value.</p></li><li><p><code>--n-clusters=&lt;nc&gt;</code>:                  Number of molecule clusters, i.e. major cell types. Depends on protocol resolution,                                       but should not be too high. In most cases something between 3 and 15 should work well.                                       (default: 4)</p></li><li><p><code>-o, --output=&lt;path&gt;</code>:                Name of the output file or path to the output directory (default: &quot;segmentation.csv&quot;)</p></li><li><p><code>--polygon-format=&lt;format&gt;</code>:          Format to save estimated cell boundary polygons to a file with a specified <code>format</code>.                                       Two types of &#39;GeoJSON&#39; format are currently supported: &#39;FeatureCollection&#39; produces the                                       same output as Xenium Ranger and &#39;GeometryCollection&#39; is the old Baysor format. Set to &quot;none&quot;                                       to disable saving polygons. (default: &#39;FeatureCollection&#39;).</p></li><li><p><code>--scale-std=&lt;ss&gt;</code>:                   Standard deviation of scale across cells. Can be either number, which means absolute value of                                       the std, or string ended with &#39;%&#39; to set it relative to scale (default: &quot;25%&quot;)</p></li><li><p><code>-s, --scale=&lt;s&gt;</code>:                    Scale parameter, which suggest approximate cell radius for the algorithm. Must be in the same                                       units as <code>x</code> and <code>y</code> molecule coordinates. Overrides the config value.                                       Sets <code>estimate-scale-from-centers</code> to <code>false</code>.</p></li><li><p><code>--prior-segmentation-confidence=&lt;p&gt;</code>:    Confidence of the <code>prior_segmentation</code> results. Value in [0; 1].                                           If you want the final segmentation not contradicting to <code>prior_segmentation</code>, set it to 1.                                           Otherwise, if you assume errors in prior_segmentation, values in [0.2-0.7] allow                                           flexibility for the algorithm. (default: 0.2)</p></li><li><p><code>--count-matrix-format=&lt;format&gt;</code>:     Storage format of the segmentec cell count matrix. Either &#39;loom&#39; or &#39;tsv&#39; (default: &#39;loom&#39;)</p></li></ul><p><strong>Flags</strong></p><ul><li><code>-p, --plot</code>:             Save an HTML with the plot of the segmentation</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/kharchenkolab/Baysor/blob/9e163c4671ff206ce8283ca5c184a694c36dd160/src/cli/main.jl#L5-L50">source</a></section></article><p>For the description of all config parameters, see <a href="https://github.com/kharchenkolab/Baysor/blob/master/configs/example_config.toml">example_config.toml</a>.</p><h2 id="Using-a-prior-segmentation"><a class="docs-heading-anchor" href="#Using-a-prior-segmentation">Using a prior segmentation</a><a id="Using-a-prior-segmentation-1"></a><a class="docs-heading-anchor-permalink" href="#Using-a-prior-segmentation" title="Permalink"></a></h2><p>In some cases, you may want to use another segmentation as a prior for Baysor. The most popular case is having a segmentation based on DAPI/poly-A stainings: such information helps to understand where nuclei are positioned, but it&#39;s often quite imprecise. To take this segmentation into account you can pass it as the second positional argument to Baysor:</p><pre><code class="language-bash hljs">baysor run [ARGS] MOLECULES_FILE [PRIOR_SEGMENTATION]</code></pre><p>Here, <code>PRIOR_SEGMENTATION</code> can be a path to a binary image with a segmentation mask, an image with integer cell segmentation labels or a column name in the <code>MOLECULES_FILE</code> with integer cell assignment per molecule (<code>0</code> value means no assignment). In the latter case, the column name must have <code>:</code> prefix, e.g. for column <code>cell</code> you should use <code>baysor run [ARGS] molecules.csv :cell</code>. In case the image is too big to be stored in the tiff format, Baysor supports MATLAB &#39;.mat&#39; format: it should contain a single field with an integer matrix for either a binary mask or segmentation labels. When loading the segmentation, Baysor filters segments that have less than <code>min-molecules-per-segment</code> molecules. It can be set in the toml config, and the default value is <code>min-molecules-per-segment = min-molecules-per-cell / 4</code>. <strong>Note:</strong> only CSV column prior is currently supported for 3D segmentation.</p><p>To specify the expected quality of the prior segmentation you may use <code>prior-segmentation-confidence</code> parameter. The value <code>0.0</code> makes the algorithm ignore the prior, while the value <code>1.0</code> restricts the algorithm from contradicting the prior. Prior segmentation is mainly needed for the cases where gene expression signal is not enough, e.g. with very sparse protocols (such as ISS or DARTFISH). Another potential use case is high-quality data with a visible sub-cellular structure. In these situations, setting <code>prior-segmentation-confidence &gt; 0.7</code> is recommended. Otherwise, the default value <code>0.2</code> should work well.</p><h3 id="Segmenting-stains"><a class="docs-heading-anchor" href="#Segmenting-stains">Segmenting stains</a><a id="Segmenting-stains-1"></a><a class="docs-heading-anchor-permalink" href="#Segmenting-stains" title="Permalink"></a></h3><p>If you have a non-segmented DAPI image, the simplest way to segment it would go through the following steps <a href="https://fiji.sc/">ImageJ</a>:</p><ol><li>Open the image (File -&gt; Open)</li><li>Go to Image -&gt; Type and pick &quot;8-bit&quot;</li><li>Run Process -&gt; Filters -&gt; Gaussian Blur, using Sigma = 1.0. <em>The value can vary, depending on your DAPI, but 1.0 generally works fine.</em></li><li>Run Image -&gt; Adjust -&gt; Auto Threshold, using Method = Default. <em>Different methods can give the best results for different cases. Often &quot;Mean&quot; also works well.</em></li><li>Run Process -&gt; Binary -&gt; Watershed</li><li>Save the resulting image in the .tif</li></ol><p>Another promising tool is <a href="https://github.com/mouseland/cellpose">CellPose</a>, however, it may require some manual labeling to fine-tune the network.</p><h2 id="Segmenting-cells-with-pronounced-intracellular-structure"><a class="docs-heading-anchor" href="#Segmenting-cells-with-pronounced-intracellular-structure">Segmenting cells with pronounced intracellular structure</a><a id="Segmenting-cells-with-pronounced-intracellular-structure-1"></a><a class="docs-heading-anchor-permalink" href="#Segmenting-cells-with-pronounced-intracellular-structure" title="Permalink"></a></h2><p>High-resolution protocols, such as MERFISH or seq-FISH, can capture the intracellular structure. Most often, it would mean a pronounced difference between nuclear and cytoplasmic gene composition. By default, such differences would push Baysor to recognize compartments as different cells. However, if some compartment-specific genes are known, they may be used to mitigate the situation. These genes can be specified through <code>--config.segmentation.nuclei-genes</code> and <code>--config.segmentation.cyto-genes</code> options, <em>e.g.</em>:</p><pre><code class="language-julia hljs">baysor run -m 30 --n-clusters=1 -s 30 --scale-std=50% --config.segmentation.nuclei-genes=Neat1 --config.segmentation.cyto-genes=Apob,Net1,Slc5a1,Mptx2 --config.data.exclude-genes=&#39;Blank*&#39; ./molecules.csv</code></pre><p>Please, notice that it&#39;s highly recommended to set <code>--n-clusters=1</code>, so molecule clustering would not be affected by compartment differences.</p><p><strong>Note.</strong> Currently, there is no automated way to determine such compartment-specific genes. So, the only way we can suggest is interactive explaration of data. In theory, it should be straightforward to infer such information from DAPI and poly-A stains, however, it is not implemented yet. If you have a particular need for such functionality, please submit an issue with the description of your experimental setup.</p><h2 id="Outputs"><a class="docs-heading-anchor" href="#Outputs">Outputs</a><a id="Outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Outputs" title="Permalink"></a></h2><h3 id="Segmentation-results"><a class="docs-heading-anchor" href="#Segmentation-results">Segmentation results</a><a id="Segmentation-results-1"></a><a class="docs-heading-anchor-permalink" href="#Segmentation-results" title="Permalink"></a></h3><ul><li><strong>segmentation_counts.loom</strong> or <strong>segmentation_counts.tsv</strong> (depends on <code>--count-matrix-format</code>): count matrix with segmented stats. In the case of loom format, column attributes also contain the same info as <strong>segmentation_cell_stats.csv</strong>.</li><li><strong>segmentation.csv</strong>: segmentation info per molecule:<ul><li><code>confidence</code>: probability of a molecule to be real (i.e. not noise)</li><li><code>cell</code>: id of the assigned cell. Value &quot;&quot; corresponds to noise.</li><li><code>cluster</code>: id of the molecule cluster</li><li><code>assignment_confidence</code>: confidence that the molecule is assigned to a correct cell</li><li><code>is_noise</code>: shows whether molecule was assigned to noise <em>(it equals <code>true</code> if and only if <code>cell</code> == &quot;&quot;)</em></li><li><code>ncv_color</code>: RGB code of the neighborhood composition coloring</li></ul></li><li><strong>segmentation_cell_stats.csv</strong>: diagnostic info about cells. The following parameters can be used to filter low-quality cells:<ul><li><code>area</code>: area of the convex hull around the cell molecules</li><li><code>avg_confidence</code>: average confidence of the cell molecules</li><li><code>density</code>: the number of molecules in a cell divided by the cell area</li><li><code>elongation</code>: ratio of the two eigenvalues of the cell covariance matrix</li><li><code>n_transcripts</code>: number of molecules per cell</li><li><code>avg_assignment_confidence</code>: average assignment confidence per cell. Cells with low <code>avg_assignment_confidence</code> have a much higher chance of being an artifact.</li><li><code>max_cluster_frac</code> <em>(only if <code>n-clusters &gt; 1</code>)</em>: fraction of the molecules coming from the most popular cluster. Cells with low <code>max_cluster_frac</code> are often doublets.</li><li><code>lifespan</code>: number of iterations the given component exists. The maximal <code>lifespan</code> is clipped proportionally to the total number of iterations. Components with a short lifespan likely correspond to noise.</li></ul></li></ul><h3 id="Visualization"><a class="docs-heading-anchor" href="#Visualization">Visualization</a><a id="Visualization-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization" title="Permalink"></a></h3><ul><li><strong>segmentation_polygons_2d/3d.json</strong>: polygons used for visualization in GeoJSON format. In the case of 3D segmentation, <code>2d.json</code> file contains polygons for all molecules pulled across the z-stack. And 3D shows polygons per z-slice. In case of continuous z, it&#39;s binned into 20 uniform bins. Depending on the format, it can contain <code>GeometryCollection</code> or <code>FeatureCollection</code>:<ul><li>For 3D, the file contains an array of dictionaries (one per z-slice), each of which representing a <code>Collection</code>. For 2D data it&#39;s just a single dictionary with a <code>Collection</code>.</li><li>Each <code>GeometryCollection</code> has a field <code>geometries</code>, which is an array of polygons with <code>cell</code> field set to cell ids and <code>coordinates</code> set to its coordinates.</li><li><code>FeatureCollection</code> is the format, compatible with <a href="https://www.10xgenomics.com/support/software/xenium-ranger/1.7/analysis/inputs/XR-input-overview#compat-files">10x SpaceRanger</a>. It contains a list of <code>Feature</code>s with cell ids saved in the <code>id</code> field and coordinates in <code>geometry/coordinates</code>.</li></ul></li><li><strong>segmentation_diagnostics.html</strong>: visualization of the algorithm QC. <em>Shown only when <code>-p</code> is set.</em></li><li><strong>segmentation_borders.html</strong>: visualization of cell borders for the dataset colored by local gene expression composition (first part) and molecule clusters (second part). <em>Shown only when <code>-p</code> is set.</em></li></ul><h3 id="Other"><a class="docs-heading-anchor" href="#Other">Other</a><a id="Other-1"></a><a class="docs-heading-anchor-permalink" href="#Other" title="Permalink"></a></h3><ul><li><strong>segmentation_params.dump.toml</strong>: aggregated parameters from the config and CLI</li></ul><h2 id="Choice-of-parameters"><a class="docs-heading-anchor" href="#Choice-of-parameters">Choice of parameters</a><a id="Choice-of-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Choice-of-parameters" title="Permalink"></a></h2><p>Most important parameters:</p><ul><li><code>scale</code> is the most sensitive parameter, which specifies the expected radius of a cell. It doesn&#39;t have to be precise, but the wrong setup can lead to over- or under-segmentation. This parameter is inferred automatically if cell centers are provided.</li><li><code>min-molecules-per-cell</code> is the number of molecules, required for a cell to be considered as real. It really depends on the protocol. For instance, for ISS it&#39;s fine to set it to 3, while for MERFISH it can require hundreds of molecules.</li></ul><p>Run parameters:</p><ul><li><code>--config.segmentation.n-cells-init</code> expected number of cells in data. This parameter influences the convergence speed of the algorithm, as well as peak memory usage. Setting this value too small would lead to under-segmentation.</li><li><code>--config.segmentation.iters</code> number of iterations for the algorithm. <strong>At the moment, no convergence criteria are implemented, so it will work exactly <code>iters</code> iterations</strong>. Thus, too small values would lead to non-convergence of the algorithm, while larger ones would just increase working time. Optimal values can be estimated by the convergence plots in the diagnostics report.</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../run/">« Summary</a><a class="docs-footer-nextpage" href="../preview/">Preview »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 24 September 2024 22:46">Tuesday 24 September 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
